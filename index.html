<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armar Expediente - Sistema Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        .preview-item {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .preview-img-container {
            width: 100%;
            height: 100px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #eee;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .preview-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        .action-btn {
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-rotate { flex-grow: 1; }
        .btn-delete { background: #991b1b; width: 30px; }
        .input-group {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            align-items: center;
        }
        /* Estilos para el Modal de Alerta */
        #custom-alert-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div id="custom-alert-overlay">
        <div class="bg-white rounded-lg shadow-2xl w-11/12 max-w-md overflow-hidden transform transition-all">
            <div class="bg-gray-800 text-white px-4 py-2 flex justify-between items-center">
                <span class="font-bold text-sm tracking-wider">SISTEMA EXPEDIENTE</span>
            </div>
            <div class="p-6">
                <p id="custom-alert-message" class="text-gray-700 text-sm md:text-base"></p>
            </div>
            <div class="bg-gray-50 px-4 py-3 text-right">
                <button onclick="cerrarAlerta()" class="bg-gray-800 text-white px-6 py-2 rounded text-sm font-semibold hover:bg-gray-700 transition-colors">ACEPTAR</button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-4 md:p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8 text-gray-800 uppercase">ARMAR EXPEDIENTE</h1>

        <div class="space-y-6">
            <div class="border-b pb-4">
                <label class="block font-bold mb-2 text-sm md:text-base uppercase">ComitÃ© de CrÃ©dito</label>
                <div class="input-group">
                    <input type="file" accept="image/*" onchange="procesarInput(this, 'fijo-0')" class="flex-grow border p-2 rounded text-xs cursor-pointer min-w-0">
                    <input type="file" accept="image/*" capture="environment" onchange="procesarInput(this, 'fijo-0')" class="hidden" id="cam-fijo-0">
                    <button onclick="document.getElementById('cam-fijo-0').click()" class="bg-gray-700 text-white px-3 py-2 rounded text-sm shrink-0">ðŸ“·</button>
                </div>
                <div class="preview-grid" id="preview-fijo-0"></div>
            </div>

            <div class="border-b pb-4">
                <label class="block font-bold mb-2 text-sm md:text-base uppercase">Solicitud de CrÃ©dito (MÃ¡x 4 fotos)</label>
                <div class="input-group mb-2">
                    <input type="file" accept="image/*" multiple onchange="procesarMultipleSolicitud(this)" class="flex-grow border p-2 rounded text-xs cursor-pointer min-w-0">
                    <input type="file" accept="image/*" capture="environment" onchange="procesarMultipleSolicitud(this)" class="hidden" id="cam-solicitud-multi">
                    <button onclick="document.getElementById('cam-solicitud-multi').click()" class="bg-gray-700 text-white px-3 py-2 rounded text-sm shrink-0">ðŸ“·</button>
                </div>
                <div class="preview-grid" id="preview-solicitud-grid"></div>
            </div>

            <div class="border-b pb-4">
                <label class="block font-bold mb-2 text-sm md:text-base uppercase">Croquis del Grupo</label>
                <div class="input-group">
                    <input type="file" accept="image/*" onchange="procesarInput(this, 'fijo-3')" class="flex-grow border p-2 rounded text-xs cursor-pointer min-w-0">
                    <input type="file" accept="image/*" capture="environment" onchange="procesarInput(this, 'fijo-3')" class="hidden" id="cam-fijo-3">
                    <button onclick="document.getElementById('cam-fijo-3').click()" class="bg-gray-700 text-white px-3 py-2 rounded text-sm shrink-0">ðŸ“·</button>
                </div>
                <div class="preview-grid" id="preview-fijo-3"></div>
            </div>

            <div class="border-b pb-4">
                <label class="block font-bold mb-2 text-sm md:text-base uppercase">Acta de Compromiso</label>
                <div class="input-group">
                    <input type="file" accept="image/*" onchange="procesarInput(this, 'fijo-2')" class="flex-grow border p-2 rounded text-xs cursor-pointer min-w-0">
                    <input type="file" accept="image/*" capture="environment" onchange="procesarInput(this, 'fijo-2')" class="hidden" id="cam-fijo-2">
                    <button onclick="document.getElementById('cam-fijo-2').click()" class="bg-gray-700 text-white px-3 py-2 rounded text-sm shrink-0">ðŸ“·</button>
                </div>
                <div class="preview-grid" id="preview-fijo-2"></div>
            </div>
        </div>

        <div id="clientes-container" class="mt-8 space-y-4">
            <h2 class="text-xl font-semibold italic text-gray-700 uppercase">SecciÃ³n Clientes</h2>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <button onclick="agregarCliente()" class="bg-blue-600 text-white px-4 py-3 sm:py-2 rounded hover:bg-blue-700 font-medium w-full sm:w-auto order-2 sm:order-1">
                + Agregar Cliente
            </button>
            <button onclick="generarPDF()" class="bg-green-600 text-white px-4 py-3 sm:py-2 rounded hover:bg-green-700 font-medium w-full sm:w-auto order-1 sm:order-2">
                Descargar PDF Final
            </button>
            <button onclick="borrarTodo()" class="bg-red-500 text-white px-4 py-3 sm:py-2 rounded hover:bg-red-600 font-medium w-full sm:w-auto order-3">
                Borrar Todo
            </button>
        </div>
    </div>

    <script>
        // --- SISTEMA DE ALERTA PERSONALIZADO ---
        function mostrarAlerta(mensaje) {
            document.getElementById('custom-alert-message').innerText = mensaje;
            document.getElementById('custom-alert-overlay').style.display = 'flex';
        }
        function cerrarAlerta() {
            document.getElementById('custom-alert-overlay').style.display = 'none';
        }

        let clienteCount = 0;
        let db;
        const listaDocumentos = [
            "DNI frontal", 
            "DNI posterior", 
            "Selfin de casa", 
            "Selfin negocio", 
            "foto negocio", 
            "negocio 1", 
            "negocio 2", 
            "recibo de luz o DJ", 
            "Sentinel"
        ];

        const request = indexedDB.open("ExpedienteDB", 1);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("datos", { keyPath: "id" });
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            restaurarDatos();
        };

        async function guardarDato(id, valor) {
            const tx = db.transaction("datos", "readwrite");
            tx.objectStore("datos").put({ id, valor });
        }

        async function obtenerDato(id) {
            return new Promise((resolve) => {
                const tx = db.transaction("datos", "readonly");
                const req = tx.objectStore("datos").get(id);
                req.onsuccess = () => resolve(req.result ? req.result.valor : null);
            });
        }

        async function eliminarDato(id) {
            const tx = db.transaction("datos", "readwrite");
            tx.objectStore("datos").delete(id);
        }

        async function procesarMultipleSolicitud(input) {
            if (input.files) {
                const filesArray = Array.from(input.files);
                let countExistente = 0;
                for(let i=0; i<4; i++) if(await obtenerDato(`fijo-1-${i}`)) countExistente++;
                let fotosAProcesar = filesArray.slice(0, 4 - countExistente);
                for(let file of fotosAProcesar) {
                    for(let i=0; i<4; i++) {
                        if(!(await obtenerDato(`fijo-1-${i}`))) {
                            const base64 = await readFileAsDataURL(file);
                            await guardarDato(`fijo-1-${i}`, base64);
                            await guardarDato(`fijo-1-${i}-rot`, 0);
                            renderPreview(`fijo-1-${i}`, base64, 0);
                            break;
                        }
                    }
                }
                input.value = "";
            }
        }

        async function procesarInput(input, storageId) {
            if (input.files && input.files[0]) {
                const base64 = await readFileAsDataURL(input.files[0]);
                await guardarDato(storageId, base64);
                await guardarDato(storageId + "-rot", 0);
                renderPreview(storageId, base64, 0);
            }
        }

        function renderPreview(storageId, base64, rotation) {
            let container;
            if (storageId.startsWith('fijo-1-')) {
                let subContainer = document.getElementById(`preview-item-${storageId}`);
                if(!subContainer) {
                    subContainer = document.createElement('div');
                    subContainer.id = `preview-item-${storageId}`;
                    subContainer.className = "preview-item";
                    document.getElementById('preview-solicitud-grid').appendChild(subContainer);
                }
                container = subContainer;
            } else {
                container = document.getElementById(`preview-${storageId}`);
                if(!container) return;
            }

            container.innerHTML = `
                <div class="preview-img-container">
                    <img src="${base64}" class="preview-img" style="transform: rotate(${rotation}deg)">
                </div>
                <div class="flex gap-1">
                    <button class="action-btn btn-rotate flex-grow" onclick="rotarImagen('${storageId}')">ðŸ”„ Girar</button>
                    <button class="action-btn btn-delete" onclick="quitarFoto('${storageId}')">X</button>
                </div>
            `;
        }

        async function quitarFoto(storageId) {
            if(confirm("Â¿Eliminar esta foto?")) {
                await eliminarDato(storageId);
                await eliminarDato(storageId + "-rot");
                if (storageId.startsWith('fijo-1-')) {
                    const el = document.getElementById(`preview-item-${storageId}`);
                    if(el) el.remove();
                } else {
                    const el = document.getElementById(`preview-${storageId}`);
                    if(el) el.innerHTML = "";
                }
            }
        }

        async function rotarImagen(storageId) {
            let currentRot = await obtenerDato(storageId + "-rot") || 0;
            let newRot = (currentRot + 90) % 360;
            await guardarDato(storageId + "-rot", newRot);
            const base64 = await obtenerDato(storageId);
            renderPreview(storageId, base64, newRot);
        }

        function agregarCliente(nombreGuardado = "", idPersistente = null) {
            if (!idPersistente) clienteCount++;
            else clienteCount = Math.max(clienteCount, idPersistente);
            const idActual = idPersistente || clienteCount;
            const container = document.getElementById('clientes-container');
            const clienteDiv = document.createElement('div');
            clienteDiv.className = "border rounded bg-gray-50 overflow-hidden";
            clienteDiv.id = `cliente-wrapper-${idActual}`;
            
            let opciones = listaDocumentos.map(doc => `<option value="${doc}">${doc}</option>`).join('');
            clienteDiv.innerHTML = `
                <div class="w-full p-4 bg-gray-200 font-bold flex flex-wrap justify-between items-center gap-2">
                    <div class="flex-grow cursor-pointer min-w-[150px]" onclick="toggleAcordeon('cliente-${idActual}')">
                        <span class="text-sm">Cliente: <input type="text" id="nombre-input-${idActual}" value="${nombreGuardado}" onchange="actualizarNombreCliente(${idActual}, this.value)" placeholder="Nombre" class="bg-transparent border-b border-gray-400 focus:outline-none w-1/2" onclick="event.stopPropagation()"></span>
                        <span class="ml-1 text-xs text-gray-500">â–¼</span>
                    </div>
                    <button onclick="eliminarCliente(${idActual})" class="bg-red-800 text-white text-[10px] px-2 py-1 rounded">BORRAR</button>
                </div>
                <div id="cliente-${idActual}" class="p-4 hidden space-y-4">
                    <div class="bg-white p-3 rounded border">
                        <select onchange="validarRequisitosYFlujo(${idActual}, this)" class="w-full border p-2 rounded text-sm bg-gray-50">
                            <option value="">-- Seleccione un tipo --</option>
                            ${opciones}
                        </select>
                    </div>
                    <div id="documentos-lista-${idActual}" class="space-y-4"></div>
                </div>
            `;
            container.appendChild(clienteDiv);
            if(!idPersistente) guardarDato(`cliente-${idActual}-nombre`, "");
            guardarDato("clienteCount", clienteCount);
        }

        async function validarRequisitosYFlujo(cliId, selectEl) {
            const tipoSeleccionado = selectEl.value;
            if(!tipoSeleccionado) return;

            const nombreActual = document.getElementById(`nombre-input-${cliId}`).value.trim();
            if(!nombreActual) {
                mostrarAlerta("Es necesario agregar un nombre del cliente para continuar");
                selectEl.value = "";
                return;
            }

            const ordenActual = await obtenerDato(`cli-${cliId}-orden`) || [];
            
            if(ordenActual.some(item => item.tipo === tipoSeleccionado)) {
                mostrarAlerta(`La secciÃ³n "${tipoSeleccionado}" ya existe para este cliente.`);
                selectEl.value = "";
                return;
            }

            const indexSeleccionado = listaDocumentos.indexOf(tipoSeleccionado);
            const esNegocio = (tipoSeleccionado === "negocio 1" || tipoSeleccionado === "negocio 2");

            if(esNegocio) {
                const requisitos = ["DNI frontal", "DNI posterior", "Selfin de casa", "Selfin negocio", "foto negocio"];
                let faltantes = [];
                requisitos.forEach(req => {
                    if(!ordenActual.some(item => item.tipo === req)) faltantes.push(req);
                });

                if(faltantes.length > 0) {
                    mostrarAlerta(`No puede agregar "${tipoSeleccionado}" sin antes haber agregado las secciones de flujo obligatorio: ${faltantes.join(", ")}.`);
                    selectEl.value = "";
                    return;
                }
            } else {
                for(let i = 0; i < indexSeleccionado; i++) {
                    const tipoNecesario = listaDocumentos[i];
                    if(tipoNecesario === "negocio 1" || tipoNecesario === "negocio 2") continue;
                    const existe = ordenActual.some(item => item.tipo === tipoNecesario);
                    if(!existe) {
                        mostrarAlerta(`Error de orden: Primero debe seleccionar "${tipoNecesario}" antes de agregar "${tipoSeleccionado}".`);
                        selectEl.value = "";
                        return;
                    }
                }
            }

            crearCampoDocumento(cliId, tipoSeleccionado);
            selectEl.value = "";
        }

        async function crearCampoDocumento(cliId, tipoDoc, idUnicoGuardado = null) {
            const container = document.getElementById(`documentos-lista-${cliId}`);
            const idUnico = idUnicoGuardado || Date.now() + Math.random().toString(36).substr(2, 5);
            const div = document.createElement('div');
            div.className = "doc-item border-l-4 border-blue-400 bg-white p-3 shadow-sm rounded";
            div.id = `doc-wrapper-${idUnico}`;
            div.setAttribute('data-tipo', tipoDoc);
            const storageId = `img-${cliId}-${idUnico}-0`;
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-blue-800 uppercase">${tipoDoc}</span>
                    <button onclick="eliminarSeccionDoc('${cliId}', '${idUnico}')" class="text-red-800 text-[10px] font-bold uppercase">Borrar SecciÃ³n</button>
                </div>
                <div class="mb-2">
                    <div class="input-group">
                        <input type="file" accept="image/*" onchange="procesarInput(this, '${storageId}')" class="flex-grow border p-1 rounded text-[10px] min-w-0">
                        <input type="file" accept="image/*" capture="environment" onchange="procesarInput(this, '${storageId}')" class="hidden" id="cam-${storageId}">
                        <button onclick="document.getElementById('cam-${storageId}').click()" class="bg-gray-600 text-white px-2 py-1 rounded text-xs shrink-0">ðŸ“·</button>
                    </div>
                    <div class="preview-grid" id="preview-${storageId}"></div>
                </div>
            `;
            const indexReferencia = listaDocumentos.indexOf(tipoDoc);
            const hijos = Array.from(container.children);
            let insertado = false;
            for (let hijo of hijos) {
                if (listaDocumentos.indexOf(hijo.getAttribute('data-tipo')) > indexReferencia) {
                    container.insertBefore(div, hijo);
                    insertado = true;
                    break;
                }
            }
            if (!insertado) container.appendChild(div);
            if(!idUnicoGuardado) {
                let ordenActual = await obtenerDato(`cli-${cliId}-orden`) || [];
                ordenActual.push({id: idUnico, tipo: tipoDoc});
                await guardarDato(`cli-${cliId}-orden`, ordenActual);
            }
        }

        async function eliminarSeccionDoc(cliId, idUnico) {
            if(confirm("Â¿Eliminar esta secciÃ³n?")) {
                document.getElementById(`doc-wrapper-${idUnico}`).remove();
                let ordenActual = await obtenerDato(`cli-${cliId}-orden`) || [];
                ordenActual = ordenActual.filter(item => item.id !== idUnico);
                await guardarDato(`cli-${cliId}-orden`, ordenActual);
                await eliminarDato(`img-${cliId}-${idUnico}-0`);
                await eliminarDato(`img-${cliId}-${idUnico}-0-rot`);
            }
        }

        async function restaurarDatos() {
            for(let i of [0, 3, 2]) {
                const img = await obtenerDato(`fijo-${i}`);
                if(img) renderPreview(`fijo-${i}`, img, await obtenerDato(`fijo-${i}-rot`) || 0);
            }
            for(let i=0; i<4; i++) {
                const img = await obtenerDato(`fijo-1-${i}`);
                if(img) renderPreview(`fijo-1-${i}`, img, await obtenerDato(`fijo-1-${i}-rot`) || 0);
            }
            const savedCount = await obtenerDato("clienteCount") || 0;
            for(let i=1; i<=savedCount; i++) {
                const nombre = await obtenerDato(`cliente-${i}-nombre`);
                if(nombre !== null) {
                    agregarCliente(nombre, i);
                    const orden = await obtenerDato(`cli-${i}-orden`) || [];
                    const ordenados = orden.sort((a,b) => listaDocumentos.indexOf(a.tipo) - listaDocumentos.indexOf(b.tipo));
                    for(let item of ordenados) {
                        await crearCampoDocumento(i, item.tipo, item.id);
                        const storageId = `img-${i}-${item.id}-0`;
                        const img = await obtenerDato(storageId);
                        if(img) renderPreview(storageId, img, await obtenerDato(storageId + "-rot") || 0);
                    }
                }
            }
        }

        async function prepararImagenPDF(storageId) {
            const imgData = await obtenerDato(storageId);
            if (!imgData) return null;
            const rot = await obtenerDato(storageId + "-rot") || 0;
            const img = new Image();
            img.src = imgData;
            await img.decode();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if(rot === 90 || rot === 270) { canvas.width = img.height; canvas.height = img.width; }
            else { canvas.width = img.width; canvas.height = img.height; }
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.rotate(rot * Math.PI / 180);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            return { url: canvas.toDataURL('image/jpeg', 0.8), w: canvas.width, h: canvas.height };
        }

        async function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pw = doc.internal.pageSize.getWidth();
            const ph = doc.internal.pageSize.getHeight();
            let firstPage = true;

            const addImageToDoc = (imgObj, x, y, maxW, maxH) => {
                const ratio = imgObj.w / imgObj.h;
                let w = maxW, h = w / ratio;
                if (h > maxH) { h = maxH; w = h * ratio; }
                doc.addImage(imgObj.url, 'JPEG', x + (maxW - w) / 2, y + (maxH - h) / 2, w, h);
            };

            const imgComite = await prepararImagenPDF('fijo-0');
            if(imgComite) { doc.addImage(imgComite.url, 'JPEG', 10, 10, pw-20, ph-20); firstPage = false; }

            const fotosSolicitud = [];
            for(let i=0; i<4; i++) {
                const img = await prepararImagenPDF(`fijo-1-${i}`);
                if(img) fotosSolicitud.push(img);
            }
            if(fotosSolicitud.length > 0) {
                if(!firstPage) doc.addPage();
                let x = 10, y = 10, boxW = (pw-30)/2, boxH = (ph-30)/2;
                fotosSolicitud.forEach((img) => {
                    addImageToDoc(img, x, y, boxW, boxH);
                    x += boxW + 10;
                    if(x + boxW > pw) { x = 10; y += boxH + 10; }
                });
                firstPage = false;
            }

            for(let key of ['fijo-3', 'fijo-2']) {
                const img = await prepararImagenPDF(key);
                if(img) { doc.addPage(); addImageToDoc(img, 10, 10, pw-20, ph-20); }
            }

            const savedCount = await obtenerDato("clienteCount") || 0;
            for (let i = 1; i <= savedCount; i++) {
                if (await obtenerDato(`cliente-${i}-nombre`) === null) continue;
                const orden = await obtenerDato(`cli-${i}-orden`) || [];
                const docsCliente = [];
                for (let item of orden.sort((a,b) => listaDocumentos.indexOf(a.tipo) - listaDocumentos.indexOf(b.tipo))) {
                    const foto = await prepararImagenPDF(`img-${i}-${item.id}-0`);
                    if (foto) docsCliente.push({ tipo: item.tipo, foto });
                }

                const dniFotos = docsCliente.filter(d => d.tipo.startsWith("DNI")).map(d => d.foto);
                if (dniFotos.length > 0) {
                    doc.addPage();
                    if (dniFotos[0]) addImageToDoc(dniFotos[0], 10, 10, pw - 20, (ph / 2) - 15);
                    if (dniFotos[1]) addImageToDoc(dniFotos[1], 10, ph / 2, pw - 20, (ph / 2) - 15);
                }

                const fotosGrid = docsCliente.filter(d => ["Selfin de casa", "Selfin negocio", "foto negocio", "negocio 1", "negocio 2"].includes(d.tipo)).map(d => d.foto);
                if (fotosGrid.length > 0) {
                    doc.addPage();
                    let x = 10, y = 10, boxW = (pw-30)/2, boxH = (ph-40)/3;
                    fotosGrid.forEach((img, idx) => {
                        if(idx > 0 && idx % 6 === 0) { doc.addPage(); x=10; y=10; }
                        addImageToDoc(img, x, y, boxW, boxH);
                        x += boxW + 10;
                        if(x + boxW > pw) { x = 10; y += boxH + 10; }
                    });
                }

                const fotosFin = docsCliente.filter(d => ["recibo de luz o DJ", "Sentinel"].includes(d.tipo)).map(d => d.foto);
                if (fotosFin.length > 0) {
                    doc.addPage();
                    if (fotosFin[0]) addImageToDoc(fotosFin[0], 10, 10, pw - 20, (ph / 2) - 15);
                    if (fotosFin[1]) addImageToDoc(fotosFin[1], 10, ph / 2, pw - 20, (ph / 2) - 15);
                }
            }
            doc.save("expediente_profesional.pdf");
        }

        async function eliminarCliente(id) {
            if(confirm("Â¿Eliminar cliente completo?")) {
                const el = document.getElementById(`cliente-wrapper-${id}`);
                if(el) el.remove();
                const orden = await obtenerDato(`cli-${id}-orden`) || [];
                for(let item of orden) {
                    await eliminarDato(`img-${id}-${item.id}-0`);
                    await eliminarDato(`img-${id}-${item.id}-0-rot`);
                }
                await eliminarDato(`cli-${id}-orden`);
                await eliminarDato(`cliente-${id}-nombre`);
            }
        }

        async function actualizarNombreCliente(id, valor) { await guardarDato(`cliente-${id}-nombre`, valor); }
        function toggleAcordeon(id) { document.getElementById(id).classList.toggle('hidden'); }
        function borrarTodo() { if(confirm("Â¿Borrar TODO el expediente?")) { indexedDB.deleteDatabase("ExpedienteDB"); location.reload(); } }
        function readFileAsDataURL(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.readAsDataURL(file); }); }
    </script>
</body>
</html>
