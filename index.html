<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA EXPEDIENTE - Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        @media (min-width: 768px) {
            .preview-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
        }

        .preview-img-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
        }

        .preview-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .btn-mini-rotate {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }

        .btn-mini-delete-img {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }

        #custom-alert-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        #fullscreen-viewer {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            overflow: hidden;
            touch-action: none;
            align-items: center;
            justify-content: center;
        }
        #img-full {
            max-width: 100%;
            max-height: 100%;
            user-select: none;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }

        .seccion-incompleta { background-color: #fee2e2 !important; border: 2px solid #ef4444 !important; }
        .seccion-completa { background-color: #dcfce7 !important; border: 2px solid #22c55e !important; }
        .cliente-header-incompleto { background-color: #fee2e2 !important; border: 2px solid #ef4444 !important; }
        .cliente-header-completo { background-color: #dcfce7 !important; border: 2px solid #22c55e !important; }
        
        .status-badge { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        input, select, textarea { font-size: 16px !important; }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-open .accordion-content {
            max-height: 2000px;
            padding-bottom: 1rem;
        }
        
        .accordion-arrow { transition: transform 0.3s ease; }
        .accordion-open .accordion-arrow { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 antialiased">

    <div id="fullscreen-viewer">
        <div id="close-viewer" onclick="cerrarVisor()" class="absolute top-5 right-5 bg-white text-black w-10 h-10 rounded-full flex items-center justify-center font-bold cursor-pointer z-[10001]">‚úï</div>
        <img id="img-full" src="" alt="Vista previa">
    </div>

    <div id="custom-alert-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-slate-800 text-white px-4 py-3 font-bold text-xs uppercase tracking-widest">SISTEMA EXPEDIENTE</div>
            <div class="p-5 text-slate-600 text-sm leading-relaxed" id="custom-alert-message"></div>
            <div class="p-5 pt-0 hidden" id="custom-alert-input-container">
                <input type="text" id="custom-alert-input" class="w-full p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="p-3 bg-slate-50 flex justify-end gap-2" id="alert-buttons-container"></div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto min-h-screen flex flex-col p-3 md:p-6">
        <header class="bg-white rounded-2xl shadow-sm p-4 md:p-6 mb-6 border border-slate-200">
            <h1 class="text-xl md:text-2xl font-black text-center text-slate-800 uppercase tracking-tighter">Armar Expediente</h1>
        </header>

        <main class="flex-grow space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="box-fijo-0" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all">
                    <div class="p-4 flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('accordion-open')">
                        <div><label class="block text-[10px] font-black uppercase text-slate-400">Comit√© de Cr√©dito</label><span id="badge-fijo-0" class="status-badge bg-red-100 text-red-600">Incompleto</span></div>
                        <span class="text-slate-400 accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content px-4">
                        <div class="flex gap-2">
                            <input type="file" accept="image/*" multiple onchange="procesarInputMultiple(this, 'fijo-0')" class="block w-full text-xs">
                            <button onclick="document.getElementById('cam-f-0').click()" class="bg-slate-800 text-white p-2 rounded-xl">üì∑</button>
                            <input type="file" capture="environment" class="hidden" id="cam-f-0" onchange="procesarInputMultiple(this, 'fijo-0')">
                        </div>
                        <div class="preview-grid" id="preview-fijo-0"></div>
                    </div>
                </div>

                <div id="box-fijo-1" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all">
                    <div class="p-4 flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('accordion-open')">
                        <div><label class="block text-[10px] font-black uppercase text-slate-400">Solicitud de Cr√©dito</label><span id="badge-fijo-1" class="status-badge bg-red-100 text-red-600">Incompleto</span></div>
                        <span class="text-slate-400 accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content px-4">
                        <div class="flex gap-2">
                            <input type="file" accept="image/*" multiple onchange="procesarInputMultiple(this, 'fijo-1')" class="block w-full text-xs">
                            <button onclick="document.getElementById('cam-sol-m').click()" class="bg-slate-800 text-white p-2 rounded-xl">üì∑</button>
                            <input type="file" capture="environment" class="hidden" id="cam-sol-m" onchange="procesarInputMultiple(this, 'fijo-1')">
                        </div>
                        <div class="preview-grid" id="preview-fijo-1"></div>
                    </div>
                </div>

                <div id="box-fijo-3" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all">
                    <div class="p-4 flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('accordion-open')">
                        <div><label class="block text-[10px] font-black uppercase text-slate-400">Croquis del Grupo</label><span id="badge-fijo-3" class="status-badge bg-red-100 text-red-600">Incompleto</span></div>
                        <span class="text-slate-400 accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content px-4">
                        <div class="flex gap-2">
                            <input type="file" accept="image/*" multiple onchange="procesarInputMultiple(this, 'fijo-3')" class="block w-full text-xs">
                            <button onclick="document.getElementById('cam-f-3').click()" class="bg-slate-800 text-white p-2 rounded-xl">üì∑</button>
                            <input type="file" capture="environment" class="hidden" id="cam-f-3" onchange="procesarInputMultiple(this, 'fijo-3')">
                        </div>
                        <div class="preview-grid" id="preview-fijo-3"></div>
                    </div>
                </div>

                <div id="box-fijo-2" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all">
                    <div class="p-4 flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('accordion-open')">
                        <div><label class="block text-[10px] font-black uppercase text-slate-400">Acta de Compromiso</label><span id="badge-fijo-2" class="status-badge bg-red-100 text-red-600">Incompleto</span></div>
                        <span class="text-slate-400 accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content px-4">
                        <div class="flex gap-2">
                            <input type="file" accept="image/*" multiple onchange="procesarInputMultiple(this, 'fijo-2')" class="block w-full text-xs">
                            <button onclick="document.getElementById('cam-f-2').click()" class="bg-slate-800 text-white p-2 rounded-xl">üì∑</button>
                            <input type="file" capture="environment" class="hidden" id="cam-f-2" onchange="procesarInputMultiple(this, 'fijo-2')">
                        </div>
                        <div class="preview-grid" id="preview-fijo-2"></div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-600 p-5 rounded-2xl shadow-lg">
                <label class="block text-[10px] font-black uppercase text-blue-200 mb-3 text-center tracking-widest">Registrar nuevo integrante</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="nombre-cliente-temporal" placeholder="Nombres y Apellidos" class="flex-grow p-3 rounded-xl border-none outline-none text-sm font-bold shadow-inner">
                    <button onclick="confirmarNuevoCliente()" class="bg-white text-blue-600 px-6 py-3 rounded-xl font-black text-sm uppercase">Confirmar</button>
                </div>
            </div>

            <div id="clientes-container" class="space-y-3 pt-4">
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] border-b pb-2">Lista de Expedientes Individuales</h2>
            </div>
        </main>

        <footer class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-3 pb-6">
            <button onclick="generarPDF()" class="bg-emerald-500 text-white py-4 rounded-2xl font-black uppercase text-sm shadow-lg">Descargar PDF Final</button>
            <button onclick="borrarTodoConfirm()" class="bg-slate-200 text-slate-500 py-4 rounded-2xl font-bold uppercase text-xs">Limpiar todo</button>
        </footer>
    </div>

    <script>
        let db, clienteCount = 0;
        const listaDocs = ["DNI frontal", "DNI posterior", "Selfin de casa", "Selfin negocio", "foto negocio", "negocio 1", "negocio 2", "recibo de luz o DJ", "Sentinel"];

        // --- GESTOS Y ZOOM ---
        let scale = 1, lastX = 0, lastY = 0, posX = 0, posY = 0, isDragging = false, startDist = 0, initialScale = 1;
        const viewer = document.getElementById('fullscreen-viewer'), imgFull = document.getElementById('img-full');

        function actualizarTransform() {
            const rot = imgFull.dataset.rot || 0;
            imgFull.style.transform = `translate(${posX}px, ${posY}px) rotate(${rot}deg) scale(${scale})`;
        }
        viewer.addEventListener('touchstart', e => {
            if (e.touches.length === 1) { isDragging = true; lastX = e.touches[0].pageX - posX; lastY = e.touches[0].pageY - posY; } 
            else if (e.touches.length === 2) { isDragging = false; startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); initialScale = scale; }
        });
        viewer.addEventListener('touchmove', e => {
            e.preventDefault();
            if (e.touches.length === 1 && isDragging) { posX = e.touches[0].pageX - lastX; posY = e.touches[0].pageY - lastY; } 
            else if (e.touches.length === 2) { const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); scale = Math.min(Math.max(initialScale * (dist / startDist), 0.5), 5); }
            actualizarTransform();
        });
        viewer.addEventListener('touchend', () => { isDragging = false; });
        function abrirVisor(b64, rot) { scale = 1; posX = 0; posY = 0; imgFull.src = b64; imgFull.dataset.rot = rot; actualizarTransform(); viewer.style.display = 'flex'; }
        function cerrarVisor() { viewer.style.display = 'none'; }

        // --- ALERTAS ---
        function mostrarAlerta(m) {
            document.getElementById('custom-alert-message').innerText = m;
            document.getElementById('custom-alert-input-container').classList.add('hidden');
            document.getElementById('alert-buttons-container').innerHTML = `<button onclick="cerrarAlerta()" class="bg-slate-800 text-white px-5 py-2 rounded-lg text-xs font-bold uppercase">Entendido</button>`;
            document.getElementById('custom-alert-overlay').style.display = 'flex';
        }
        function mostrarConfirmacion(m, callback) {
            document.getElementById('custom-alert-message').innerText = m;
            document.getElementById('custom-alert-input-container').classList.add('hidden');
            document.getElementById('alert-buttons-container').innerHTML = `<button onclick="cerrarAlerta()" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold uppercase">Cancelar</button><button id="confirm-btn-action" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">Confirmar</button>`;
            document.getElementById('confirm-btn-action').onclick = () => { callback(); cerrarAlerta(); };
            document.getElementById('custom-alert-overlay').style.display = 'flex';
        }
        function mostrarPrompt(m, valInicial, callback) {
            document.getElementById('custom-alert-message').innerText = m;
            const inputContainer = document.getElementById('custom-alert-input-container');
            const input = document.getElementById('custom-alert-input');
            inputContainer.classList.remove('hidden');
            input.value = valInicial;
            document.getElementById('alert-buttons-container').innerHTML = `<button onclick="cerrarAlerta()" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold uppercase">Cancelar</button><button id="prompt-btn-action" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">Guardar</button>`;
            document.getElementById('prompt-btn-action').onclick = () => { callback(input.value); cerrarAlerta(); };
            document.getElementById('custom-alert-overlay').style.display = 'flex';
        }
        function cerrarAlerta() { document.getElementById('custom-alert-overlay').style.display = 'none'; }

        // --- DATABASE ---
        const request = indexedDB.open("ExpedienteDB", 1);
        request.onupgradeneeded = (e) => { db = e.target.result; db.createObjectStore("datos", { keyPath: "id" }); };
        request.onsuccess = (e) => { db = e.target.result; restaurarDatos(); };
        async function guardarDato(id, valor) { const tx = db.transaction("datos", "readwrite"); tx.objectStore("datos").put({ id, valor }); }
        async function obtenerDato(id) { return new Promise(r => { const tx = db.transaction("datos", "readonly"); const req = tx.objectStore("datos").get(id); req.onsuccess = () => r(req.result ? req.result.valor : null); }); }
        async function eliminarDato(id) { const tx = db.transaction("datos", "readwrite"); tx.objectStore("datos").delete(id); }

        // --- CLIENTES ---
        function confirmarNuevoCliente() {
            const input = document.getElementById('nombre-cliente-temporal');
            if (!input.value.trim()) { mostrarAlerta("Es necesario agregar un nombre del cliente para continuar."); return; }
            agregarCliente(input.value.trim()); input.value = "";
        }

        async function agregarCliente(nom = "", idPersist = null) {
            if (!idPersist) { clienteCount++; await guardarDato("clienteCount", clienteCount); } 
            else { clienteCount = Math.max(clienteCount, idPersist); }
            const idActual = idPersist || clienteCount;
            const div = document.createElement('div');
            div.className = "bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden transition-all duration-300";
            div.id = `cliente-wrapper-${idActual}`;
            div.innerHTML = `
                <div id="header-cli-${idActual}" class="p-3 flex items-center justify-between gap-2 cursor-pointer transition-colors" onclick="this.parentElement.classList.toggle('accordion-open')">
                    <div class="flex flex-col min-w-0">
                        <input type="text" id="input-nom-${idActual}" value="${nom}" readonly class="bg-transparent font-black text-slate-700 outline-none text-sm pointer-events-none truncate max-w-[140px]">
                        <span id="header-status-${idActual}" class="status-badge w-fit">Incompleto</span>
                    </div>
                    <div class="flex items-center gap-3" onclick="event.stopPropagation()">
                        <div class="flex gap-1">
                            <button onclick="editarNombreCliente(${idActual})" class="bg-blue-50 text-blue-500 p-2 rounded-lg text-xs">‚úèÔ∏è</button>
                            <button onclick="eliminarClienteConfirm(${idActual})" class="bg-red-50 text-red-500 p-2 rounded-lg text-xs">üóëÔ∏è</button>
                        </div>
                        <span class="text-slate-400 accordion-arrow text-xs">‚ñº</span>
                    </div>
                </div>
                <div id="cliente-${idActual}" class="accordion-content px-4 bg-white">
                    <div class="border-t pt-4 space-y-4">
                        <select onchange="validarRequisitosYFlujo(${idActual}, this)" class="w-full p-3 rounded-xl bg-slate-100 text-xs font-black uppercase outline-none">
                            <option value="">+ AGREGAR SECCI√ìN</option>
                            ${listaDocs.map(d => `<option value="${d}">${d}</option>`).join('')}
                        </select>
                        <div id="documentos-lista-${idActual}" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                    </div>
                </div>`;
            document.getElementById('clientes-container').appendChild(div);
            if(!idPersist) guardarDato(`cliente-${idActual}-nombre`, nom);
            verificarEstadoCliente(idActual);
        }

        async function editarNombreCliente(id) {
            const actual = document.getElementById(`input-nom-${id}`).value;
            mostrarPrompt("Editar nombre del cliente:", actual, async (nuevoNom) => {
                if(nuevoNom && nuevoNom.trim() !== "") {
                    document.getElementById(`input-nom-${id}`).value = nuevoNom.trim();
                    await guardarDato(`cliente-${id}-nombre`, nuevoNom.trim());
                }
            });
        }

        // --- FOTOS ---
        async function procesarInputMultiple(input, sIdBase) {
            if (input.files) {
                const files = Array.from(input.files);
                for (let file of files) {
                    const b64 = await readFileAsDataURL(file);
                    if (sIdBase === 'fijo-1') {
                        for (let i = 0; i < 4; i++) {
                            if (!(await obtenerDato(`fijo-1-${i}`))) {
                                await guardarDato(`fijo-1-${i}`, b64); await guardarDato(`fijo-1-${i}-rot`, 0);
                                renderPreview(`fijo-1-${i}`, b64, 0); break;
                            }
                        }
                    } else {
                        await guardarDato(sIdBase, b64); await guardarDato(sIdBase + "-rot", 0);
                        renderPreview(sIdBase, b64, 0);
                    }
                }
                actualizarColorGrupo(sIdBase);
                if (sIdBase.includes('img-')) { const p = sIdBase.split('-'); verificarEstadoCliente(p[1]); }
                input.value = "";
            }
        }

        async function actualizarColorGrupo(idRef) {
            const boxId = idRef.startsWith('fijo-1-') || idRef === 'fijo-1' ? 'fijo-1' : idRef;
            const box = document.getElementById(`box-${boxId}`), badge = document.getElementById(`badge-${boxId}`);
            if (!box || !badge) return;
            let tiene = false;
            if (boxId === 'fijo-1') { for(let i=0; i<4; i++) if(await obtenerDato(`fijo-1-${i}`)) { tiene = true; break; } } 
            else if(await obtenerDato(idRef)) tiene = true;
            if(tiene) { box.className = "bg-white rounded-2xl shadow-sm border transition-all seccion-completa overflow-hidden"; badge.innerText = "Completo"; badge.className = "status-badge bg-emerald-100 text-emerald-600"; }
            else { box.className = "bg-white rounded-2xl shadow-sm border transition-all seccion-incompleta overflow-hidden"; badge.innerText = "Incompleto"; badge.className = "status-badge bg-red-100 text-red-600"; }
        }

        async function verificarEstadoCliente(cliId) {
            const h = document.getElementById(`header-cli-${cliId}`), b = document.getElementById(`header-status-${cliId}`), o = await obtenerDato(`cli-${cliId}-orden`) || [];
            if (o.length === 0) { h.className = "p-3 flex items-center justify-between gap-2 cursor-pointer border rounded-2xl bg-slate-50"; b.innerText = "Sin secciones"; return; }
            let inc = false; for (let i of o) { if (!(await obtenerDato(`img-${cliId}-${i.id}-0`))) { inc = true; break; } }
            if (inc) { h.parentElement.className = "bg-white border transition-all cliente-header-incompleto rounded-2xl overflow-hidden"; b.innerText = "Incompleto"; b.className = "status-badge bg-red-100 text-red-600"; }
            else { h.parentElement.className = "bg-white border transition-all cliente-header-completo rounded-2xl overflow-hidden"; b.innerText = "Completo"; b.className = "status-badge bg-emerald-100 text-emerald-600"; }
            for (let i of o) {
                const foto = await obtenerDato(`img-${cliId}-${i.id}-0`);
                const secBox = document.getElementById(`doc-wrapper-${i.id}`);
                const secBadge = document.getElementById(`badge-${i.id}`);
                if(secBox) secBox.className = `bg-slate-50 p-3 rounded-2xl border transition-all ${!foto ? 'seccion-incompleta' : 'seccion-completa'}`;
                if(secBadge) { secBadge.innerText = !foto ? 'Incompleto' : 'Completo'; secBadge.className = `status-badge ${!foto ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`; }
            }
        }

        async function crearCampoDoc(cliId, t, idUG = null) {
            const idU = idUG || Date.now() + Math.random().toString(36).substr(2, 4), sId = `img-${cliId}-${idU}-0`, foto = await obtenerDato(sId);
            const div = document.createElement('div'); div.id = `doc-wrapper-${idU}`;
            div.className = `bg-slate-50 p-3 rounded-2xl border transition-all ${!foto ? 'seccion-incompleta' : 'seccion-completa'}`;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div><span class="text-[9px] font-black uppercase text-slate-400">${t}</span><br><span id="badge-${idU}" class="status-badge">Incompleto</span></div>
                    <button onclick="eliminarSeccionDocConfirm('${cliId}','${idU}')" class="text-red-400 text-[9px] font-bold uppercase">Quitar</button>
                </div>
                <div class="flex gap-2 mb-2">
                    <input type="file" accept="image/*" multiple onchange="procesarInputMultiple(this,'${sId}')" class="text-[10px] w-full">
                    <button onclick="document.getElementById('cam-${sId}').click()" class="bg-white border p-1 rounded-lg">üì∑</button>
                    <input type="file" capture="environment" class="hidden" id="cam-${sId}" onchange="procesarInputMultiple(this,'${sId}')">
                </div>
                <div class="preview-grid" id="preview-${sId}"></div>`;
            document.getElementById(`documentos-lista-${cliId}`).appendChild(div);
            if(!idUG) { let o = await obtenerDato(`cli-${cliId}-orden`) || []; o.push({id:idU, tipo:t}); await guardarDato(`cli-${cliId}-orden`, o); verificarEstadoCliente(cliId); }
            if(foto) renderPreview(sId, foto, await obtenerDato(sId + "-rot") || 0);
        }

        function renderPreview(sId, b64, rot) {
            let container;
            if (sId.startsWith('fijo-1-')) {
                container = document.getElementById(`preview-item-${sId}`) || (() => { let n = document.createElement('div'); n.id = `preview-item-${sId}`; document.getElementById('preview-fijo-1').appendChild(n); return n; })();
            } else { container = document.getElementById(`preview-${sId}`); }
            if(!container) return;
            container.innerHTML = `<div class="preview-img-container" onclick="abrirVisor('${b64}', ${rot})"><button class="btn-mini-delete-img" onclick="event.stopPropagation(); quitarFotoConfirm('${sId}')">X</button><button class="btn-mini-rotate" onclick="event.stopPropagation(); rotarImagen('${sId}')">‚Ü∫</button><img src="${b64}" class="preview-img" style="transform: rotate(${rot}deg)"></div>`;
        }

        async function rotarImagen(sId) { let r = ((await obtenerDato(sId + "-rot") || 0) + 90) % 360; await guardarDato(sId + "-rot", r); renderPreview(sId, await obtenerDato(sId), r); }
        async function quitarFotoConfirm(sId) { mostrarConfirmacion("¬øDesea eliminar esta fotograf√≠a?", async () => { await eliminarDato(sId); location.reload(); }); }
        function readFileAsDataURL(f) { return new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); }); }
        
        async function restaurarDatos() {
            for(let i of ['fijo-0', 'fijo-1', 'fijo-2', 'fijo-3']) {
                if(i === 'fijo-1') { for(let j=0; j<4; j++) { const f = await obtenerDato(`fijo-1-${j}`); if(f) renderPreview(`fijo-1-${j}`, f, await obtenerDato(`fijo-1-${j}-rot`) || 0); } }
                else { const f = await obtenerDato(i); if(f) renderPreview(i, f, await obtenerDato(i + "-rot") || 0); }
                actualizarColorGrupo(i);
            }
            const sc = await obtenerDato("clienteCount") || 0;
            for(let i=1; i<=sc; i++) { const n = await obtenerDato(`cliente-${i}-nombre`); if(n !== null) { await agregarCliente(n, i); const o = await obtenerDato(`cli-${i}-orden`) || []; for(let it of o) { await crearCampoDoc(i, it.tipo, it.id); } } }
        }

        async function eliminarClienteConfirm(id) { mostrarConfirmacion("¬øDesea eliminar este integrante?", async () => { document.getElementById(`cliente-wrapper-${id}`).remove(); await eliminarDato(`cliente-${id}-nombre`); await eliminarDato(`cli-${id}-orden`); }); }
        async function eliminarSeccionDocConfirm(cliId, idU) { mostrarConfirmacion("¬øDesea quitar esta secci√≥n?", async () => { document.getElementById(`doc-wrapper-${idU}`).remove(); let o = (await obtenerDato(`cli-${cliId}-orden`) || []).filter(i => i.id !== idU); await guardarDato(`cli-${cliId}-orden`, o); verificarEstadoCliente(cliId); }); }
        function borrarTodoConfirm() { mostrarConfirmacion("¬øBorrar todo?", () => { indexedDB.deleteDatabase("ExpedienteDB"); location.reload(); }); }

        // --- GENERACI√ìN DE PDF CORREGIDO (SIN HOJA EN BLANCO FINAL) ---
        async function generarPDF() {
            const fechaActual = new Date().toLocaleDateString().replace(/\//g, '-');
            const nombreSugerido = `Expediente_Grupo_${fechaActual}`;
            
            mostrarPrompt("Ingrese un nombre para el archivo PDF:", nombreSugerido, async (nombreArchivo) => {
                if (!nombreArchivo || nombreArchivo.trim() === "") nombreArchivo = nombreSugerido;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                mostrarAlerta("Generando PDF, por favor espere...");

                const drawWithBorder = async (imgId, x, y, w, h) => {
                    const b64 = await obtenerDato(imgId);
                    if (b64) {
                        try {
                            doc.setDrawColor(200, 200, 200);
                            doc.setLineWidth(0.2);
                            doc.rect(x - 0.5, y - 0.5, w + 1, h + 1);
                            doc.addImage(b64, 'JPEG', x, y, w, h);
                            return true;
                        } catch(e) { return false; }
                    }
                    return false;
                };

                const drawSeccionGrupal = async (imgId, titulo) => {
                    doc.setFontSize(16); doc.setTextColor(0, 0, 0);
                    doc.text(titulo, 10, 15);
                    const exito = await drawWithBorder(imgId, 10, 25, 190, 250);
                    if(!exito) { doc.setFontSize(10); doc.text("(Secci√≥n vac√≠a)", 10, 30); }
                };

                // 1. COMIT√â
                await drawSeccionGrupal("fijo-0", "COMIT√â DE CR√âDITO");
                doc.addPage();

                // 2. SOLICITUD
                doc.setFontSize(16); doc.text("SOLICITUD DE CR√âDITO", 10, 15);
                let tieneSol = false;
                for(let j=0; j<4; j++){
                    const fSol = await obtenerDato(`fijo-1-${j}`);
                    if(fSol){
                        if(tieneSol) { doc.addPage(); doc.text("SOLICITUD DE CR√âDITO (Continuaci√≥n)", 10, 15); }
                        await drawWithBorder(`fijo-1-${j}`, 10, 25, 190, 250);
                        tieneSol = true;
                    }
                }
                if(!tieneSol) { doc.text("(Secci√≥n vac√≠a)", 10, 30); }
                doc.addPage();

                // 3. CROQUIS
                await drawSeccionGrupal("fijo-3", "CROQUIS DEL GRUPO");
                doc.addPage();

                // 4. ACTA
                await drawSeccionGrupal("fijo-2", "ACTA DE COMPROMISO");
                
                // CLIENTES INDIVIDUALES
                const sc = await obtenerDato("clienteCount") || 0;
                let clientesValidos = [];
                for(let i=1; i<=sc; i++) {
                    const nom = await obtenerDato(`cliente-${i}-nombre`);
                    if(nom) clientesValidos.push({id: i, nombre: nom});
                }

                for(let idxCli=0; idxCli < clientesValidos.length; idxCli++) {
                    doc.addPage(); // Siempre agregamos p√°gina antes de empezar un nuevo cliente
                    const cli = clientesValidos[idxCli];
                    const orden = await obtenerDato(`cli-${cli.id}-orden`) || [];

                    // HOJA DNIs
                    doc.setFontSize(14); doc.setTextColor(0, 0, 255);
                    doc.text(`INTEGRANTE: ${cli.nombre} - DNI`, 10, 15);
                    doc.setTextColor(0, 0, 0);
                    let dniF = orden.find(it => it.tipo === "DNI frontal");
                    let dniP = orden.find(it => it.tipo === "DNI posterior");
                    if(dniF) await drawWithBorder(`img-${cli.id}-${dniF.id}-0`, 10, 25, 190, 115);
                    if(dniP) await drawWithBorder(`img-${cli.id}-${dniP.id}-0`, 10, 150, 190, 115);

                    // HOJA NEGOCIO
                    doc.addPage();
                    doc.setTextColor(0, 0, 255);
                    doc.text(`INTEGRANTE: ${cli.nombre} - NEGOCIO`, 10, 15);
                    doc.setTextColor(0, 0, 0);
                    let sCasa = orden.find(it => it.tipo === "Selfin de casa");
                    let sNeg = orden.find(it => it.tipo === "Selfin negocio");
                    let fNeg = orden.find(it => it.tipo === "foto negocio");
                    let n1 = orden.find(it => it.tipo === "negocio 1");
                    let n2 = orden.find(it => it.tipo === "negocio 2");
                    if(sCasa) await drawWithBorder(`img-${cli.id}-${sCasa.id}-0`, 10, 25, 93, 70);
                    if(sNeg) await drawWithBorder(`img-${cli.id}-${sNeg.id}-0`, 107, 25, 93, 70);
                    if(fNeg) await drawWithBorder(`img-${cli.id}-${fNeg.id}-0`, 10, 100, 190, 95);
                    if(n1) await drawWithBorder(`img-${cli.id}-${n1.id}-0`, 10, 200, 93, 70);
                    if(n2) await drawWithBorder(`img-${cli.id}-${n2.id}-0`, 107, 200, 93, 70);

                    // HOJA OTROS
                    doc.addPage();
                    doc.setTextColor(0, 0, 255);
                    doc.text(`INTEGRANTE: ${cli.nombre} - OTROS`, 10, 15);
                    doc.setTextColor(0, 0, 0);
                    let rec = orden.find(it => it.tipo === "recibo de luz o DJ");
                    let sen = orden.find(it => it.tipo === "Sentinel");
                    if(rec) await drawWithBorder(`img-${cli.id}-${rec.id}-0`, 10, 25, 190, 115);
                    if(sen) await drawWithBorder(`img-${cli.id}-${sen.id}-0`, 10, 150, 190, 115);
                }

                doc.save(`${nombreArchivo}.pdf`);
                cerrarAlerta();
            });
        }

        async function validarRequisitosYFlujo(cliId, sel) {
            const tipo = sel.value; if(!tipo) return;
            const ord = await obtenerDato(`cli-${cliId}-orden`) || [];
            if(ord.some(i => i.tipo === tipo)) { mostrarAlerta("Esta secci√≥n ya ha sido agregada."); sel.value = ""; return; }
            if(tipo === "negocio 1" || tipo === "negocio 2") {
                const reqs = ["DNI frontal", "DNI posterior", "Selfin de casa", "Selfin negocio", "foto negocio"];
                let falt = reqs.filter(r => !ord.some(i => i.tipo === r));
                if(falt.length > 0) { mostrarAlerta(`Faltan secciones obligatorias: ${falt.join(", ")}`); sel.value = ""; return; }
            } else {
                const idx = listaDocs.indexOf(tipo);
                for(let i=0; i<idx; i++) { if(listaDocs[i].includes("negocio")) continue; if(!ord.some(it => it.tipo === listaDocs[i])) { mostrarAlerta(`Falta secci√≥n previa: ${listaDocs[i]}`); sel.value = ""; return; } }
            }
            crearCampoDoc(cliId, tipo); sel.value = "";
        }
    </script>
</body>
</html>
